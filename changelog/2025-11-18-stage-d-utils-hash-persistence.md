# 2025-11-18 阶段D：抽取 hash 与 persistence 工具\n\n## 变更\n- 新增 `src/utils/hash.ts`：\n  - 提供 `encodeViewStateToHash`/`decodeHashToViewState`，统一负责 `#pb=...` 分享链接的 encode/decode。\n  - 内部仍使用原有的 `btoa`/`atob` + `encodeURIComponent`/`decodeURIComponent` + `escape`/`unescape` 方案，保持编码格式不变。\n- 新增 `src/utils/persistence.ts`：\n  - 定义 `PIXEL_STORAGE_KEY` 与 `PixelStoragePayload`，集中描述本地存档格式 `{ w, h, b64, s? }`。\n  - 提供 `u8ToB64`/`b64ToU8` 作为通用的像素缓冲与 base64 编解码工具。\n  - 提供 `savePixelStorage`/`loadPixelStorage` 封装 `localStorage` 读写与 JSON 序列化。\n- 调整 `src/store/pixel-sharing.slice.ts`：\n  - 使用 `encodeViewStateToHash`/`decodeHashToViewState` 实现 `exportHash`/`applyHash`。\n  - 使用 `PIXEL_STORAGE_KEY` + `savePixelStorage`/`loadPixelStorage` 替代直接访问 `localStorage`，复用 `u8ToB64`/`b64ToU8`。\n  - 保持对外 API 与行为不变（存档结构与分享链接格式均未修改）。\n\n## 测试\n- 暂未执行（建议在本地运行：`npm run lint && npm run test && npm run test:bench`）。\n
